---
import type { NotionBlock } from '@/lib/notion/types';

interface Props {
  blocks: NotionBlock[];
}

const { blocks } = Astro.props;

function renderRichText(richText: any[]): string {
  if (!richText || richText.length === 0) return '';

  return richText
    .map((text) => {
      let content = text.plain_text;

      if (text.annotations.bold) content = `<strong>${content}</strong>`;
      if (text.annotations.italic) content = `<em>${content}</em>`;
      if (text.annotations.code) content = `<code class="px-1.5 py-0.5 bg-gray-100 rounded text-sm font-mono">${content}</code>`;
      if (text.annotations.strikethrough) content = `<del>${content}</del>`;
      if (text.href) content = `<a href="${text.href}" class="text-blue-600 hover:underline" target="_blank" rel="noopener">${content}</a>`;

      return content;
    })
    .join('');
}
---

<div class="notion-content space-y-5">
  {blocks.map((block) => {
    const type = block.type;
    const content = block[type];

    switch (type) {
      case 'paragraph':
        const text = renderRichText(content.rich_text);
        if (!text.trim()) return null;
        return (
          <p class="text-gray-700 text-[17px] leading-[1.8] tracking-normal" set:html={text} />
        );

      case 'heading_1':
        return (
          <h2 class="text-3xl md:text-4xl font-bold mt-12 mb-5 text-gray-900 leading-tight" set:html={renderRichText(content.rich_text)} />
        );

      case 'heading_2':
        return (
          <h3 class="text-2xl md:text-3xl font-bold mt-10 mb-4 text-gray-900 leading-tight" set:html={renderRichText(content.rich_text)} />
        );

      case 'heading_3':
        return (
          <h4 class="text-xl md:text-2xl font-semibold mt-8 mb-3 text-gray-900 leading-snug" set:html={renderRichText(content.rich_text)} />
        );

      case 'bulleted_list_item':
        return (
          <li class="ml-5 pl-2 text-gray-700 text-[17px] leading-[1.8] list-disc marker:text-blue-500" set:html={renderRichText(content.rich_text)} />
        );

      case 'numbered_list_item':
        return (
          <li class="ml-5 pl-2 text-gray-700 text-[17px] leading-[1.8] list-decimal marker:text-blue-600 marker:font-semibold" set:html={renderRichText(content.rich_text)} />
        );

      case 'quote':
        return (
          <blockquote class="border-l-4 border-blue-500 bg-blue-50/50 pl-6 pr-4 py-4 italic text-gray-700 my-6 rounded-r-lg" set:html={renderRichText(content.rich_text)} />
        );

      case 'code':
        const language = content.language || 'text';
        const code = content.rich_text.map((t: any) => t.plain_text).join('');
        return (
          <div class="my-6 rounded-xl overflow-hidden shadow-md border border-gray-200">
            <div class="bg-gray-800 px-4 py-2 flex items-center justify-between">
              <span class="text-xs text-gray-400 font-mono">{language}</span>
            </div>
            <pre class="bg-gray-900 text-gray-100 p-4 overflow-x-auto text-sm leading-relaxed"><code class={`language-${language}`}>{code}</code></pre>
          </div>
        );

      case 'image':
        const imageUrl = content.type === 'external' ? content.external.url : content.file.url;
        const caption = content.caption.length > 0 ? renderRichText(content.caption) : '';
        return (
          <figure class="my-8 -mx-4 sm:mx-0">
            <img
              src={imageUrl}
              alt={caption || 'Image'}
              class="w-full rounded-xl shadow-lg"
              loading="lazy"
              decoding="async"
              width="1200"
              height="675"
            />
            {caption && <figcaption class="text-sm text-gray-500 mt-3 text-center px-4" set:html={caption} />}
          </figure>
        );

      case 'divider':
        return <hr class="my-12 border-gray-200 border-t-2" />;

      default:
        return null;
    }
  })}
</div>
