---
import { SITE_CONFIG } from '@/site-config';

interface Props {
  type: 'website' | 'article';
  title?: string;
  description?: string;
  image?: string;
  publishedTime?: string;
  author?: string;
  slug?: string;
  tags?: string[];
}

const {
  type,
  title = SITE_CONFIG.title,
  description = SITE_CONFIG.description,
  image,
  publishedTime,
  author = SITE_CONFIG.author,
  slug,
  tags = [],
} = Astro.props;

const siteUrl = Astro.site?.toString().replace(/\/$/, '') || '';
const canonicalURL = slug ? `${siteUrl}/${slug}` : siteUrl;

// Organization schema (共通)
const organizationSchema = {
  '@type': 'Organization',
  '@id': `${siteUrl}/#organization`,
  name: SITE_CONFIG.title,
  url: siteUrl,
  logo: {
    '@type': 'ImageObject',
    url: `${siteUrl}/favicon.svg`,
  },
  sameAs: [
    SITE_CONFIG.social.twitter,
    SITE_CONFIG.social.github,
  ].filter(Boolean),
};

// WebSite schema (トップページ用)
const websiteSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  '@id': `${siteUrl}/#website`,
  url: siteUrl,
  name: SITE_CONFIG.title,
  description: SITE_CONFIG.description,
  publisher: organizationSchema,
  inLanguage: SITE_CONFIG.lang === 'ja' ? 'ja-JP' : 'en-US',
};

// OGP画像URL
const ogImageURL = slug
  ? `${siteUrl}/og/${slug}.png`
  : image
    ? (image.startsWith('http') ? image : `${siteUrl}${image}`)
    : `${siteUrl}${SITE_CONFIG.ogImage}`;

// BlogPosting schema (記事ページ用)
const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  '@id': `${canonicalURL}/#article`,
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': canonicalURL,
  },
  headline: title,
  description: description,
  image: {
    '@type': 'ImageObject',
    url: ogImageURL,
    width: 1200,
    height: 630,
  },
  datePublished: publishedTime || undefined,
  dateModified: publishedTime || undefined,
  author: {
    '@type': 'Person',
    name: author,
  },
  publisher: organizationSchema,
  inLanguage: SITE_CONFIG.lang === 'ja' ? 'ja-JP' : 'en-US',
  keywords: tags.length > 0 ? tags.join(', ') : undefined,
  isPartOf: {
    '@id': `${siteUrl}/#website`,
  },
};

// BreadcrumbList schema (記事ページ用)
const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Home',
      item: siteUrl,
    },
    ...(slug
      ? [
          {
            '@type': 'ListItem',
            position: 2,
            name: title,
            item: canonicalURL,
          },
        ]
      : []),
  ],
};

// JSON-LDを生成
const jsonLD = type === 'article'
  ? [articleSchema, breadcrumbSchema]
  : [websiteSchema];
---

{jsonLD.map((schema) => (
  <script is:inline type="application/ld+json" set:html={JSON.stringify(schema, null, 0)} />
))}
