---
/**
 * PostImage.astro - 画像最適化コンポーネント
 *
 * 動作モード:
 * - useCloudflareImageResizing: true → Cloudflare Image Resizing経由で最適化
 * - useCloudflareImageResizing: false → ビルド時ダウンロード済みのローカル画像を使用
 * - 開発時 → 元のNotion URLをそのまま使用
 *
 * site-config.ts の useCloudflareImageResizing で切り替え可能
 * LCP最適化のため、priority属性でプリロードを制御可能
 */

import { SITE_CONFIG } from '@/site-config';

interface Props {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  class?: string;
  /** LCP対象の場合はtrueを指定（fetchpriority="high", loading="eager"） */
  priority?: boolean;
  /** Cloudflare Image Resizingのオプション */
  fit?: 'scale-down' | 'contain' | 'cover' | 'crop' | 'pad';
  quality?: number;
  format?: 'webp' | 'avif' | 'auto';
}

const {
  src,
  alt,
  width = 1200,
  height = 675,
  class: className = '',
  priority = false,
  fit = 'scale-down',
  quality = 80,
  format = 'auto',
} = Astro.props;

const isProd = import.meta.env.PROD;
const useImageResizing = SITE_CONFIG.useCloudflareImageResizing && isProd;

/**
 * Cloudflare Image Resizing URL を生成
 * @see https://developers.cloudflare.com/images/transform-images/transform-via-url/
 */
function buildCloudflareImageUrl(originalUrl: string): string {
  // 既にCloudflare形式の場合はそのまま返す
  if (originalUrl.startsWith('/cdn-cgi/image/')) {
    return originalUrl;
  }

  const options = [
    `width=${width}`,
    `height=${height}`,
    `fit=${fit}`,
    `quality=${quality}`,
    `format=${format}`,
  ].join(',');

  // 相対パス（ローカル画像）の場合
  if (originalUrl.startsWith('/')) {
    return `/cdn-cgi/image/${options}${originalUrl}`;
  }

  // 外部URL（Notion S3など）の場合
  return `/cdn-cgi/image/${options}/${originalUrl}`;
}

/**
 * 画像URLを決定
 * - 本番 + Image Resizing有効 → Cloudflare経由
 * - 本番 + Image Resizing無効 → ローカルパス（既にダウンロード済み）
 * - 開発 → 元URL
 */
function getImageSrc(originalSrc: string): string {
  if (!isProd) {
    // 開発時は元URLをそのまま使用
    return originalSrc;
  }

  if (useImageResizing) {
    // Cloudflare Image Resizing経由
    return buildCloudflareImageUrl(originalSrc);
  }

  // ローカルパス（ビルド時にダウンロード済み）をそのまま返す
  // srcは既にNotionクライアントでローカルパスに変換済み
  return originalSrc;
}

const imageSrc = getImageSrc(src);

// プリロード用のヒント（LCP最適化）
const fetchPriority = priority ? 'high' : 'auto';
const loading = priority ? 'eager' : 'lazy';
const decoding = priority ? 'sync' : 'async';
---

<img
  src={imageSrc}
  alt={alt}
  width={width}
  height={height}
  class={className}
  loading={loading}
  decoding={decoding}
  fetchpriority={fetchPriority}
/>
