---
/**
 * PostImage.astro - Pro版画像最適化コンポーネント
 *
 * 本番環境: Cloudflare Image Resizing (/cdn-cgi/image/...) で動的最適化
 * 開発環境: 生のNotion URLをそのまま表示（フォールバック）
 *
 * LCP最適化のため、priority属性でプリロードを制御可能
 */

interface Props {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  class?: string;
  /** LCP対象の場合はtrueを指定（fetchpriority="high", loading="eager"） */
  priority?: boolean;
  /** Cloudflare Image Resizingのオプション */
  fit?: 'scale-down' | 'contain' | 'cover' | 'crop' | 'pad';
  quality?: number;
  format?: 'webp' | 'avif' | 'auto';
}

const {
  src,
  alt,
  width = 1200,
  height = 675,
  class: className = '',
  priority = false,
  fit = 'scale-down',
  quality = 80,
  format = 'auto',
} = Astro.props;

const isProd = import.meta.env.PROD;

/**
 * Cloudflare Image Resizing URL を生成
 * @see https://developers.cloudflare.com/images/transform-images/transform-via-url/
 */
function buildCloudflareImageUrl(originalUrl: string): string {
  // 既にCloudflare形式の場合はそのまま返す
  if (originalUrl.startsWith('/cdn-cgi/image/')) {
    return originalUrl;
  }

  // 相対パス（ローカル画像）の場合
  if (originalUrl.startsWith('/')) {
    const options = [
      `width=${width}`,
      `height=${height}`,
      `fit=${fit}`,
      `quality=${quality}`,
      `format=${format}`,
    ].join(',');

    return `/cdn-cgi/image/${options}${originalUrl}`;
  }

  // 外部URL（Notion S3など）の場合
  const options = [
    `width=${width}`,
    `height=${height}`,
    `fit=${fit}`,
    `quality=${quality}`,
    `format=${format}`,
  ].join(',');

  return `/cdn-cgi/image/${options}/${originalUrl}`;
}

// 本番環境ではCloudflare Image Resizing、開発環境では元URLを使用
const imageSrc = isProd ? buildCloudflareImageUrl(src) : src;

// プリロード用のヒント（LCP最適化）
const fetchPriority = priority ? 'high' : 'auto';
const loading = priority ? 'eager' : 'lazy';
const decoding = priority ? 'sync' : 'async';
---

<img
  src={imageSrc}
  alt={alt}
  width={width}
  height={height}
  class={className}
  loading={loading}
  decoding={decoding}
  fetchpriority={fetchPriority}
/>
